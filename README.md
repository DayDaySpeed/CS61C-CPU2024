# RISC-Væ‰€æœ‰å¯„å­˜å™¨åç§°åŠå…¶ABIåç§°





| ç¼–å· | åç§°ï¼ˆxNï¼‰ | ABI åç§°                         | ç”¨é€”è¯´æ˜                   |
| ---- | ---------- | -------------------------------- | -------------------------- |
| x0   | zero       | zero                             | å¸¸æ•° 0ï¼Œè¯»å–ä¸º 0ï¼Œå†™å…¥æ— æ•ˆ |
| x1   | ra         | return address                   | å‡½æ•°è¿”å›åœ°å€               |
| x2   | sp         | stack pointer                    | æ ˆé¡¶æŒ‡é’ˆ                   |
| x3   | gp         | global pointer                   | å…¨å±€å˜é‡æŒ‡é’ˆ               |
| x4   | tp         | thread pointer                   | çº¿ç¨‹å±€éƒ¨å­˜å‚¨æŒ‡é’ˆ           |
| x5   | t0         | temporary 0                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |
| x6   | t1         | temporary 1                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |
| x7   | t2         | temporary 2                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |
| x8   | s0         | saved register 0 / frame pointer | è¢«è°ƒç”¨è€…ä¿å­˜ / æ ˆå¸§æŒ‡é’ˆ    |
| x9   | s1         | saved register 1                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x10  | a0         | argument 0 / return value        | å‡½æ•°å‚æ•° / è¿”å›å€¼          |
| x11  | a1         | argument 1                       | å‡½æ•°å‚æ•° / è¿”å›å€¼          |
| x12  | a2         | argument 2                       | å‡½æ•°å‚æ•°                   |
| x13  | a3         | argument 3                       | å‡½æ•°å‚æ•°                   |
| x14  | a4         | argument 4                       | å‡½æ•°å‚æ•°                   |
| x15  | a5         | argument 5                       | å‡½æ•°å‚æ•°                   |
| x16  | a6         | argument 6                       | å‡½æ•°å‚æ•°                   |
| x17  | a7         | argument 7                       | å‡½æ•°å‚æ•°                   |
| x18  | s2         | saved register 2                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x19  | s3         | saved register 3                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x20  | s4         | saved register 4                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x21  | s5         | saved register 5                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x22  | s6         | saved register 6                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x23  | s7         | saved register 7                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x24  | s8         | saved register 8                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x25  | s9         | saved register 9                 | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x26  | s10        | saved register 10                | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x27  | s11        | saved register 11                | è¢«è°ƒç”¨è€…ä¿å­˜               |
| x28  | t3         | temporary 3                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |
| x29  | t4         | temporary 4                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |
| x30  | t5         | temporary 5                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |
| x31  | t6         | temporary 6                      | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰   |

**zeroï¼ˆx0ï¼‰**ï¼šæ°¸è¿œä¸º 0

**raï¼ˆx1ï¼‰**ï¼šè¿”å›åœ°å€

**spï¼ˆx2ï¼‰**ï¼šæ ˆæŒ‡é’ˆ

**gp / tpï¼ˆx3â€“x4ï¼‰**ï¼šå…¨å±€ / çº¿ç¨‹æŒ‡é’ˆ

**t0â€“t6ï¼ˆx5â€“x7, x28â€“x31ï¼‰**ï¼šä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰

**s0â€“s11ï¼ˆx8â€“x9, x18â€“x27ï¼‰**ï¼šä¿å­˜å¯„å­˜å™¨ï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜ï¼‰

**a0â€“a7ï¼ˆx10â€“x17ï¼‰**ï¼šå‡½æ•°å‚æ•° / è¿”å›å€¼



# **R-type | I-type | S-type | B-type | U-type | J-type** 

## **1.åœ¨32ä½ä¸­çš„å­—æ®µå¸ƒå±€åŠä½ä½ç½®è¯´æ˜**

| ç±»å‹       | å­—æ®µå¸ƒå±€ï¼ˆä»å·¦åˆ°å³ï¼‰                                         | ä½ä½ç½®è¯´æ˜                                                   |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **R-type** | `funct7` `rs2` `rs1` `funct3` `rd` `opcode`                  | `[31:25]` `[24:20]` `[19:15]` `[14:12]` `[11:7]` `[6:0]`     |
| **I-type** | `imm[11:0]` `rs1` `funct3` `rd` `opcode`                     | `[31:20]` `[19:15]` `[14:12]` `[11:7]` `[6:0]`               |
| **S-type** | `imm[11:5]` `rs2` `rs1` `funct3` `imm[4:0]` `opcode`         | `[31:25]` `[24:20]` `[19:15]` `[14:12]` `[11:7]` `[6:0]`     |
| **B-type** | `imm[12]` `imm[10:5]` `rs2` `rs1` `funct3` `imm[4:1]` `imm[11]` `opcode` | `[31]` `[30:25]` `[24:20]` `[19:15]` `[14:12]` `[11:8]` `[7]` `[6:0]` |
| **U-type** | `imm[31:12]` `rd` `opcode`                                   | `[31:12]` `[11:7]` `[6:0]`                                   |
| **J-type** | `imm[20]` `imm[10:1]` `imm[11]` `imm[19:12]` `rd` `opcode`   | `[31]` `[30:21]` `[20]` `[19:12]` `[11:7]` `[6:0]`           |







# R,I,S,B,U,JæŒ‡ä»¤æ€»æ½



##  I-type æŒ‡ä»¤ï¼ˆç«‹å³æ•°è¿ç®— / load / jalr ï¼‰

| æŒ‡ä»¤              | ç±»å‹ | Opcode | Funct3 | Funct7 | æ“ä½œè¯´æ˜                                |
| ----------------- | ---- | ------ | ------ | ------ | --------------------------------------- |
| addi rd, rs1, imm | I    | 0x13   | 0x0    |        | rd â† rs1 + imm                          |
| andi rd, rs1, imm | I    | 0x13   | 0x7    |        | rd â† rs1 & imm                          |
| ori rd, rs1, imm  | I    | 0x13   | 0x6    |        | rd â† rs1 \| imm                         |
| xori rd, rs1, imm | I    | 0x13   | 0x4    |        | rd â† rs1 ^ imm                          |
| slli rd, rs1, imm | I    | 0x13   | 0x1    | 0x00   | rd â† rs1 << imm                         |
| srli rd, rs1, imm | I    | 0x13   | 0x5    | 0x00   | rd â† rs1 >> imm ï¼ˆé€»è¾‘å³ç§»ï¼Œé›¶æ‰©å±•ï¼‰    |
| srai rd, rs1, imm | I    | 0x13   | 0x5    | 0x20   | rd â† rs1 >> imm ï¼ˆç®—æœ¯å³ç§»ï¼Œç¬¦å·æ‰©å±•ï¼‰  |
| slti rd, rs1, imm | I    | 0x13   | 0x2    |        | rd â† (rs1 < imm) ? 1 : 0 ï¼ˆæœ‰ç¬¦å·æ¯”è¾ƒï¼‰ |



##  R-type æŒ‡ä»¤ï¼ˆå¯„å­˜å™¨è¿ç®—ï¼‰

| æŒ‡ä»¤               | ç±»å‹ | Opcode | Funct3 | Funct7 | æ“ä½œè¯´æ˜                                             |
| ------------------ | ---- | ------ | ------ | ------ | ---------------------------------------------------- |
| add rd, rs1, rs2   | R    | 0x33   | 0x0    | 0x00   | rd â† rs1 + rs2                                       |
| sub rd, rs1, rs2   | R    | 0x33   | 0x0    | 0x20   | rd â† rs1 - rs2                                       |
| and rd, rs1, rs2   | R    | 0x33   | 0x7    | 0x00   | rd â† rs1 & rs2                                       |
| or rd, rs1, rs2    | R    | 0x33   | 0x6    | 0x00   | rd â† rs1 \| rs2                                      |
| xor rd, rs1, rs2   | R    | 0x33   | 0x4    | 0x00   | rd â† rs1 ^ rs2                                       |
| sll rd, rs1, rs2   | R    | 0x33   | 0x1    | 0x00   | rd â† rs1 << (rs2[4:0])                               |
| srl rd, rs1, rs2   | R    | 0x33   | 0x5    | 0x00   | rd â† rs1 >> (rs2[4:0]) ï¼ˆé€»è¾‘å³ç§»ï¼Œé›¶æ‰©å±•ï¼‰          |
| sra rd, rs1, rs2   | R    | 0x33   | 0x5    | 0x20   | rd â† rs1 >>> (rs2[4:0]) ï¼ˆç®—æœ¯å³ç§»ï¼Œç¬¦å·æ‰©å±•ï¼‰       |
| slt rd, rs1, rs2   | R    | 0x33   | 0x2    | 0x00   | rd â† (rs1 < rs2) ? 1 : 0 ï¼ˆæœ‰ç¬¦å·æ¯”è¾ƒï¼‰              |
| mul rd, rs1, rs2   | R    | 0x33   | 0x0    | 0x01   | rd â† (rs1 * rs2)[31:0] ï¼ˆä½ 32 ä½ç»“æœï¼‰              |
| mulh rd, rs1, rs2  | R    | 0x33   | 0x1    | 0x01   | rd â† (rs1 * rs2)[63:32] ï¼ˆé«˜ 32 ä½ç»“æœï¼Œæœ‰ç¬¦å·ä¹˜æ³•ï¼‰ |
| mulhu rd, rs1, rs2 | R    | 0x33   | 0x3    | 0x01   | rd â† (rs1 * rs2)[63:32] ï¼ˆé«˜ 32 ä½ç»“æœï¼Œæ— ç¬¦å·ä¹˜æ³•ï¼‰ |



##  B-type æŒ‡ä»¤ï¼ˆåˆ†æ”¯è·³è½¬ï¼‰

| æŒ‡ä»¤                  | ç±»å‹ | Opcode | Funct3 | æ“ä½œè¯´æ˜                                           |
| --------------------- | ---- | ------ | ------ | -------------------------------------------------- |
| beq rs1, rs2, offset  | B    | 0x63   | 0x0    | è‹¥ (rs1 == rs2)ï¼Œåˆ™ PC â† PC + offset               |
| bne rs1, rs2, offset  | B    | 0x63   | 0x1    | è‹¥ (rs1 != rs2)ï¼Œåˆ™ PC â† PC + offset               |
| blt rs1, rs2, offset  | B    | 0x63   | 0x4    | è‹¥ (rs1 < rs2) ï¼ˆæœ‰ç¬¦å·æ¯”è¾ƒï¼‰ï¼Œåˆ™ PC â† PC + offset |
| bge rs1, rs2, offset  | B    | 0x63   | 0x5    | è‹¥ (rs1 â‰¥ rs2) ï¼ˆæœ‰ç¬¦å·æ¯”è¾ƒï¼‰ï¼Œåˆ™ PC â† PC + offset |
| bltu rs1, rs2, offset | B    | 0x63   | 0x6    | è‹¥ (rs1 < rs2) ï¼ˆæ— ç¬¦å·æ¯”è¾ƒï¼‰ï¼Œåˆ™ PC â† PC + offset |
| bgeu rs1, rs2, offset | B    | 0x63   | 0x7    | è‹¥ (rs1 â‰¥ rs2) ï¼ˆæ— ç¬¦å·æ¯”è¾ƒï¼‰ï¼Œåˆ™ PC â† PC + offset |





##   L-type and S-type æŒ‡ä»¤ï¼ˆstoreï¼‰

| æŒ‡ä»¤                | ç±»å‹ | Opcode | Funct3 | æ“ä½œè¯´æ˜                                          |
| ------------------- | ---- | ------ | ------ | ------------------------------------------------- |
| lb rd, offset(rs1)  | I    | 0x03   | 0x0    | rd â† ä»åœ°å€ (rs1 + imm) å– 1 å­—èŠ‚ï¼Œå¹¶è¿›è¡Œç¬¦å·æ‰©å±• |
| lh rd, offset(rs1)  | I    | 0x03   | 0x1    | rd â† ä»åœ°å€ (rs1 + imm) å– 2 å­—èŠ‚ï¼Œå¹¶è¿›è¡Œç¬¦å·æ‰©å±• |
| lw rd, offset(rs1)  | I    | 0x03   | 0x2    | rd â† ä»åœ°å€ (rs1 + imm) å– 4 å­—èŠ‚ï¼ˆä¸€ä¸ª wordï¼‰    |
| sb rs2, offset(rs1) | S    | 0x23   | 0x0    | å°† rs2 çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚å­˜å…¥åœ°å€ (rs1 + imm)         |
| sh rs2, offset(rs1) | S    | 0x23   | 0x1    | å°† rs2 çš„æœ€ä½ 2 å­—èŠ‚å­˜å…¥åœ°å€ (rs1 + imm)          |
| sw rs2, offset(rs1) | S    | 0x23   | 0x2    | å°† rs2 çš„ 32 ä½æ•°æ®å­˜å…¥åœ°å€ (rs1 + imm)           |





## Jumpsï¼ˆè·³è½¬ï¼‰ and U-typeï¼ˆé«˜ä½ç«‹å³æ•°ï¼‰

| æŒ‡ä»¤              | ç±»å‹ | Opcode | Funct3 | æ“ä½œè¯´æ˜                      |
| ----------------- | ---- | ------ | ------ | ----------------------------- |
| jal rd, imm       | J    | 0x6f   |        | rd â† PC + 4ï¼›PC â† PC + offset |
| jalr rd, rs1, imm | I    | 0x67   | 0x0    | rd â† PC + 4ï¼›PC â† rs1 + imm   |
| auipc rd, imm     | U    | 0x17   |        | rd â† PC + imm                 |
| lui rd, imm       | U    | 0x37   |        | rd â† imm                      |



â€‹	









![](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20251115120305919.png)



# ä»»åŠ¡ï¼š

## ALU

| ALUSel Value | Instruction                              |
| ------------ | ---------------------------------------- |
| 0            | add: `Result = A + B`                    |
| 1            | sll: `Result = A << B[4:0]`              |
| 2            | slt: `Result = (A < B (signed)) ? 1 : 0` |
| 3            | Unused                                   |
| 4            | xor: `Result = A ^ B`                    |
| 5            | srl: `Result = (unsigned) A >> B[4:0]`   |
| 6            | or: `Result = A | B`                     |
| 7            | and: `Result = A & B`                    |
| 8            | mul: `Result = (signed) (A * B)[31:0]`   |
| 9            | mulh: `Result = (signed) (A * B)[63:32]` |
| 10           | Unused                                   |
| 11           | mulhu: `Result = (A * B)[63:32]`         |
| 12           | sub: `Result = A - B`                    |
| 13           | sra: `Result = (signed) A >> B[4:0]`     |
| 14           | Unused                                   |
| 15           | bsel: `Result = B`                       |

### æµ‹è¯•

```bash
bash test.sh test_alu
```





## RegFile

è¿™ä¸ªä»»åŠ¡è¦æ±‚ä½ åœ¨ **Logisim** ä¸­å®ç°ä¸€ä¸ª **å¯„å­˜å™¨æ–‡ä»¶ï¼ˆRegister Fileï¼‰**ï¼Œå®ƒæ˜¯ CPU datapath çš„æ ¸å¿ƒå­˜å‚¨å•å…ƒã€‚å¯„å­˜å™¨æ–‡ä»¶ä¿å­˜æ‰€æœ‰é€šç”¨å¯„å­˜å™¨ï¼ˆRISC-V RV32I ä¸­æœ‰ 32 ä¸ªå¯„å­˜å™¨ï¼Œæ¯ä¸ª 32 ä½ï¼‰ï¼Œå¹¶æä¾›è¯»å†™æ¥å£ã€‚

### âœ… ä½ éœ€è¦å®ç°çš„å†…å®¹

#### 1. å¯„å­˜å™¨æ•°é‡ä¸ä½å®½

- å…± **32 ä¸ªå¯„å­˜å™¨**ï¼ˆx0 ~ x31ï¼‰
- æ¯ä¸ªå¯„å­˜å™¨ **32 ä½å®½**

#### 2. ç‰¹æ®Šå¯„å­˜å™¨è§„åˆ™

- **x0 æ°¸è¿œä¸º 0**ï¼šå†™å…¥æ—¶å¿…é¡»å¿½ç•¥ï¼Œè¯»å‡ºæ—¶å§‹ç»ˆè¿”å› 0

#### 3. è¾“å…¥ç«¯å£

- `ReadReg1`ï¼šç¬¬ä¸€ä¸ªè¯»å¯„å­˜å™¨ç¼–å·ï¼ˆ5 ä½ï¼‰
- `ReadReg2`ï¼šç¬¬äºŒä¸ªè¯»å¯„å­˜å™¨ç¼–å·ï¼ˆ5 ä½ï¼‰
- `WriteReg`ï¼šå†™å¯„å­˜å™¨ç¼–å·ï¼ˆ5 ä½ï¼‰
- `WriteData`ï¼šå†™å…¥çš„æ•°æ®ï¼ˆ32 ä½ï¼‰
- `RegWrite`ï¼šå†™ä½¿èƒ½ä¿¡å·ï¼ˆ1 ä½ï¼‰

#### 4. è¾“å‡ºç«¯å£

- `ReadData1`ï¼šç¬¬ä¸€ä¸ªè¯»å¯„å­˜å™¨çš„å€¼ï¼ˆ32 ä½ï¼‰
- `ReadData2`ï¼šç¬¬äºŒä¸ªè¯»å¯„å­˜å™¨çš„å€¼ï¼ˆ32 ä½ï¼‰

#### 5. åŠŸèƒ½è¦æ±‚

- **åŒç«¯å£è¯»**ï¼šå¯ä»¥åŒæ—¶è¯»ä¸¤ä¸ªå¯„å­˜å™¨
- **å•ç«¯å£å†™**ï¼šæ¯ä¸ªå‘¨æœŸæœ€å¤šå†™ä¸€ä¸ªå¯„å­˜å™¨
- å†™æ“ä½œåœ¨æ—¶é’Ÿä¸Šå‡æ²¿ç”Ÿæ•ˆï¼ˆåŒæ­¥å†™ï¼‰
- è¯»æ“ä½œæ˜¯ç»„åˆé€»è¾‘ï¼ˆå¼‚æ­¥è¯»ï¼‰

### æµ‹è¯•

```bash
bash test.sh test_regfile
```





## imm-gen

è¿™ä¸ªä»»åŠ¡è¦æ±‚ä½ åœ¨ **Logisim** ä¸­å®ç°ä¸€ä¸ª **ç«‹å³æ•°ç”Ÿæˆå™¨ï¼ˆImmediate Generatorï¼‰**ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š ä»æŒ‡ä»¤çš„ä¸åŒå­—æ®µä¸­æå–å‡º **ç«‹å³æ•°ï¼ˆimmediateï¼‰**ï¼Œå¹¶è¿›è¡Œæ­£ç¡®çš„ **ç¬¦å·æ‰©å±•**ï¼Œä¾› ALU æˆ–å…¶ä»–å•å…ƒä½¿ç”¨ã€‚

#### ä¸åŒæŒ‡ä»¤ç±»å‹çš„ç«‹å³æ•°æ ¼å¼



| ç±»å‹ | ImmSel (é»˜è®¤) | Bits 31-20  | Bits 19-12  | Bit 11      | Bits 10-5   | Bits 4-1 | Bit 0 |
| ---- | ------------- | ----------- | ----------- | ----------- | ----------- | -------- | ----- |
| I    | 0b000         | inst[31]    | inst[30:20] |             |             |          |       |
| S    | 0b001         | inst[31]    |             | inst[30:25] | inst[11:7]  |          |       |
| B    | 0b010         | inst[31]    | inst[7]     | inst[30:25] | inst[11:8]  |          | 0     |
| U    | 0b011         | inst[31:12] |             |             |             |          | 0     |
| J    | 0b100         | inst[31]    | inst[19:12] | inst[20]    | inst[30:21] |          | 0     |



### æµ‹è¯•

```bash
bash test.sh test_imm_gen
```



# branch_comp

| ä¿¡å·åç§° | æ–¹å‘ | ä½å®½ | æè¿°                                           |
| -------- | ---- | ---- | ---------------------------------------------- |
| BrData1  | è¾“å…¥ | 32   | ç¬¬ä¸€ä¸ªæ¯”è¾ƒå€¼                                   |
| BrData2  | è¾“å…¥ | 32   | ç¬¬äºŒä¸ªæ¯”è¾ƒå€¼                                   |
| BrUn     | è¾“å…¥ | 1    | å½“ä¸º 1 æ—¶æ‰§è¡Œæ— ç¬¦å·æ¯”è¾ƒï¼›ä¸º 0 æ—¶æ‰§è¡Œæœ‰ç¬¦å·æ¯”è¾ƒ |
| BrEq     | è¾“å‡º | 1    | è‹¥ä¸¤ä¸ªå€¼ç›¸ç­‰åˆ™ç½®ä¸º 1                           |
| BrLt     | è¾“å‡º | 1    | è‹¥ rs1 çš„å€¼å°äº rs2 çš„å€¼åˆ™ç½®ä¸º 1               |







## Task4

è¿™ä¸€éƒ¨åˆ†è¦æ±‚ä½ åœ¨ **Logisim** ä¸­æŠŠä¹‹å‰å®ç°çš„å„ä¸ªç»„ä»¶ï¼ˆALUã€RegFileã€Immediate Generatorã€PC ç­‰ï¼‰ç»„åˆèµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ **å•å‘¨æœŸ CPU datapath**ã€‚

æ¢å¥è¯è¯´ï¼ŒTask 4 æ˜¯æŠŠä½ å‰é¢åšçš„é›¶ä»¶æ‹¼è£…æˆä¸€å°èƒ½è·‘ RISC-V RV32I æŒ‡ä»¤çš„å¤„ç†å™¨ã€‚

### âœ… ä½ éœ€è¦å®ç°çš„å†…å®¹

#### 1. ä¸»è¦ç»„ä»¶

- **PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰**ï¼šä¿å­˜å½“å‰æŒ‡ä»¤åœ°å€
- **IMEMï¼ˆæŒ‡ä»¤å­˜å‚¨å™¨ï¼‰**ï¼šæ ¹æ® PC å–å‡ºæŒ‡ä»¤
- **RegFileï¼ˆå¯„å­˜å™¨æ–‡ä»¶ï¼‰**ï¼šæä¾›ä¸¤ä¸ªæºæ“ä½œæ•°ï¼Œæ”¯æŒå†™å›
- **Immediate Generator**ï¼šç”Ÿæˆç«‹å³æ•°
- **ALU**ï¼šæ‰§è¡Œç®—æœ¯é€»è¾‘è¿ç®—
- **DMEMï¼ˆæ•°æ®å­˜å‚¨å™¨ï¼‰**ï¼šç”¨äº load/store
- **æ§åˆ¶é€»è¾‘ï¼ˆControl ROMï¼‰**ï¼šæ ¹æ® opcode/funct3/funct7 ç”Ÿæˆæ§åˆ¶ä¿¡å·

#### 2. å…³é”®æ§åˆ¶ä¿¡å·

- **PCSel**ï¼šå†³å®šä¸‹ä¸€æ¡ PCï¼ˆé¡ºåºã€è·³è½¬ã€å¯„å­˜å™¨è·³è½¬ï¼‰
- **ImmSel**ï¼šé€‰æ‹©ç«‹å³æ•°ç±»å‹ï¼ˆI/S/B/U/Jï¼‰
- **ALUSel**ï¼šé€‰æ‹© ALU è¿ç®—
- **RegWEn**ï¼šå¯„å­˜å™¨å†™ä½¿èƒ½
- **MemRW**ï¼šå†…å­˜è¯»/å†™æ§åˆ¶
- **WBSel**ï¼šå†³å®šå†™å›å¯„å­˜å™¨çš„æ•°æ®æ¥æºï¼ˆALUç»“æœ / å†…å­˜æ•°æ® / PC+4ï¼‰

#### 3. æ•°æ®æµï¼ˆå•å‘¨æœŸ CPUï¼‰

1. **å–æŒ‡**ï¼šPC â†’ IMEM â†’ Instruction
2. **è§£ç **ï¼šInstruction â†’ RegFile (rs1, rs2, rd) + ImmGen
3. **æ‰§è¡Œ**ï¼šALU â† (RegFileæ•°æ®, ImmGenæ•°æ®)
4. **è®¿å­˜**ï¼šALUç»“æœä½œä¸ºåœ°å€ â†’ DMEMï¼ˆè¯»/å†™ï¼‰
5. **å†™å›**ï¼šç»“æœï¼ˆALU/DMEM/PC+4ï¼‰ â†’ RegFile[rd]

#### 4. ç‰¹æ®Šè¦æ±‚

- **x0 æ’ä¸º 0**ï¼ˆå¯„å­˜å™¨æ–‡ä»¶å·²ä¿è¯ï¼‰
- **ç«‹å³æ•°æ‹¼æ¥æ­£ç¡®**ï¼ˆImmGen å·²ä¿è¯ï¼‰
- **åˆ†æ”¯/è·³è½¬æ­£ç¡®æ›´æ–° PC**
- **æ§åˆ¶ä¿¡å·æ¥è‡ª ROM**ï¼ˆä½ éœ€è¦å†™ä¸€ä¸ªæ§åˆ¶ä¿¡å·è¡¨ï¼‰

### ğŸ§ª æµ‹è¯•æ–¹å¼

è¿è¡Œé›†æˆæµ‹è¯•ï¼š

bash

```
bash test.sh test_integration_basic
bash test.sh test_integration_branch
```

### âœ… æ€»ç»“å£è¯€

> **PCå–æŒ‡ï¼ŒRegè¯»æ•°ï¼ŒImmæ‰©å±•ï¼ŒALUç®—ï¼ŒMemè®¿å­˜ï¼ŒWBå†™å›ï¼›æ§åˆ¶ä¿¡å·å…¨é ROMã€‚**



## Task 5 (I-type Instructions)

è¿™ä¸€éƒ¨åˆ†è¦æ±‚ä½ åœ¨ **æµæ°´çº¿ CPU** ä¸­å®ç° **I-type æŒ‡ä»¤**ã€‚I-type æŒ‡ä»¤æ˜¯ RISC-V RV32I ä¸­æœ€å¸¸è§çš„ä¸€ç±»ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

- ç®—æœ¯ç«‹å³æ•°æŒ‡ä»¤ï¼š`addi`, `slti`, `sltiu`
- é€»è¾‘ç«‹å³æ•°æŒ‡ä»¤ï¼š`xori`, `ori`, `andi`
- ç§»ä½ç«‹å³æ•°æŒ‡ä»¤ï¼š`slli`, `srli`, `srai`
- è·³è½¬æŒ‡ä»¤ï¼š`jalr`
- Load æŒ‡ä»¤ï¼š`lb`, `lh`, `lw`, `lbu`, `lhu`

è¿™äº›æŒ‡ä»¤éƒ½ä½¿ç”¨ **I-type æ ¼å¼**ï¼Œå³ç«‹å³æ•°åœ¨æŒ‡ä»¤çš„ `imm[11:0] = instr[31:20]` å­—æ®µã€‚

### âœ… ä½ éœ€è¦å®ç°çš„å†…å®¹

#### 1. ç®—æœ¯/é€»è¾‘ç«‹å³æ•°æŒ‡ä»¤

- **addi**: `R[rd] â† R[rs1] + imm`
- **slti**: `R[rd] â† (R[rs1] < imm) ? 1 : 0`ï¼ˆæœ‰ç¬¦å·æ¯”è¾ƒï¼‰
- **sltiu**: `R[rd] â† (R[rs1] < imm) ? 1 : 0`ï¼ˆæ— ç¬¦å·æ¯”è¾ƒï¼‰
- **xori/ori/andi**: æŒ‰ä½é€»è¾‘è¿ç®—

#### 2. ç§»ä½ç«‹å³æ•°æŒ‡ä»¤

- **slli**: `R[rd] â† R[rs1] << shamt`
- **srli**: `R[rd] â† R[rs1] >> shamt`ï¼ˆé€»è¾‘å³ç§»ï¼‰
- **srai**: `R[rd] â† R[rs1] >>> shamt`ï¼ˆç®—æœ¯å³ç§»ï¼‰
  - æ³¨æ„ï¼šç§»ä½é‡ `shamt = instr[24:20]`
  - `srai` éœ€è¦æ£€æŸ¥ `funct7 = 0x20`

#### 3. è·³è½¬æŒ‡ä»¤

- **jalr**: `PC â† (R[rs1] + imm) & ~1`ï¼ŒåŒæ—¶ `R[rd] â† PC + 4`
  - æ³¨æ„ PC å¯¹é½ï¼šæœ€ä½ä½æ¸…é›¶

#### 4. Load æŒ‡ä»¤

- **lb/lh/lw**: ä»å†…å­˜è¯»æ•°æ®å¹¶ç¬¦å·æ‰©å±•
- **lbu/lhu**: ä»å†…å­˜è¯»æ•°æ®å¹¶é›¶æ‰©å±•
- åœ°å€è®¡ç®—ï¼š`MemAddr = R[rs1] + imm`

### ğŸ› ï¸ å®ç°æ­¥éª¤

1. **Immediate Generator**
   - æå– `instr[31:20]` â†’ ç¬¦å·æ‰©å±•åˆ° 32 ä½
   - å¯¹ç§»ä½æŒ‡ä»¤ï¼Œç«‹å³æ•°åªå–ä½ 5 ä½ï¼ˆshamtï¼‰
2. **ALU æ§åˆ¶**
   - æ ¹æ® `opcode = 0x13`ï¼ˆç®—æœ¯/é€»è¾‘ç«‹å³æ•°ï¼‰å’Œ `funct3`/`funct7` é€‰æ‹© ALU è¿ç®—
   - å¯¹ `jalr`ï¼ŒPCSel = 2ï¼ˆå¯„å­˜å™¨è·³è½¬ï¼‰
3. **å¯„å­˜å™¨æ–‡ä»¶**
   - `rs1` æä¾›æ“ä½œæ•°
   - `rd` å†™å›ç»“æœï¼ˆé™¤éæ˜¯ storeï¼‰
4. **æ•°æ®å­˜å‚¨å™¨**
   - å¯¹ load æŒ‡ä»¤ï¼Œä½¿ç”¨ `partial_load` ç”µè·¯å¤„ç†å­—èŠ‚/åŠå­—æå–å’Œæ‰©å±•

### ğŸ§ª æµ‹è¯•æ–¹å¼

è¿è¡Œ I-type æŒ‡ä»¤æµ‹è¯•ï¼š

bash

```
bash test.sh test_integration_i_type -p
```

### âœ… æ€»ç»“å£è¯€

> **Iå‹æŒ‡ä»¤ï¼šç«‹å³æ•°åœ¨é«˜ä½ï¼Œç®—æœ¯é€»è¾‘ç§»ä½è·³è½¬éƒ½é å®ƒï¼›jalr æ”¹PCï¼Œloadè¦æ‰©å±•ã€‚**



##  **Task 6 (R-type Instructions)** 

è¿™ä¸€éƒ¨åˆ†è¦æ±‚ä½ åœ¨ **æµæ°´çº¿ CPU** ä¸­å®ç° **R-type æŒ‡ä»¤**ã€‚è¿™äº›æŒ‡ä»¤æ˜¯ RISC-V RV32I çš„æ ¸å¿ƒç®—æœ¯é€»è¾‘æŒ‡ä»¤ï¼Œæ“ä½œæ•°æ¥è‡ªå¯„å­˜å™¨ï¼Œä¸æ¶‰åŠç«‹å³æ•°æˆ–å†…å­˜ã€‚

### âœ… ä½ éœ€è¦å®ç°çš„å†…å®¹

#### 1. R-type æŒ‡ä»¤æ ¼å¼

- **opcode = 0x33**
- å­—æ®µï¼š
  - `rd`ï¼šç›®æ ‡å¯„å­˜å™¨
  - `rs1`, `rs2`ï¼šæºå¯„å­˜å™¨
  - `funct3`, `funct7`ï¼šå†³å®šå…·ä½“è¿ç®—

#### 2. æ”¯æŒçš„æŒ‡ä»¤

ä½ éœ€è¦å®ç°ä»¥ä¸‹ R-type æŒ‡ä»¤ï¼š

| æŒ‡ä»¤ | funct3 | funct7  | è¿ç®—è¯´æ˜                                      |      |
| ---- | ------ | ------- | --------------------------------------------- | ---- |
| add  | 000    | 0000000 | `R[rd] â† R[rs1] + R[rs2]`                     |      |
| sub  | 000    | 0100000 | `R[rd] â† R[rs1] - R[rs2]`                     |      |
| sll  | 001    | 0000000 | `R[rd] â† R[rs1] << R[rs2][4:0]`               |      |
| slt  | 010    | 0000000 | `R[rd] â† (R[rs1] < R[rs2]) ? 1 : 0`ï¼ˆæœ‰ç¬¦å·ï¼‰ |      |
| sltu | 011    | 0000000 | `R[rd] â† (R[rs1] < R[rs2]) ? 1 : 0`ï¼ˆæ— ç¬¦å·ï¼‰ |      |
| xor  | 100    | 0000000 | `R[rd] â† R[rs1] ^ R[rs2]`                     |      |
| srl  | 101    | 0000000 | `R[rd] â† R[rs1] >> R[rs2][4:0]`ï¼ˆé€»è¾‘å³ç§»ï¼‰   |      |
| sra  | 101    | 0100000 | `R[rd] â† R[rs1] >>> R[rs2][4:0]`ï¼ˆç®—æœ¯å³ç§»ï¼‰  |      |
| or   | 110    | 0000000 | `R[rd] â† R[rs1] | R[rs2]`                     |      |
| and  | 111    | 0000000 | `R[rd] â† R[rs1] & R[rs2]`                     |      |

### ğŸ§ª æµ‹è¯•æ–¹å¼

è¿è¡Œ R-type æŒ‡ä»¤æµ‹è¯•ï¼š

```bash
bash test.sh test_integration_r_type -p
```

### âœ… æ€»ç»“å£è¯€

> **Rå‹æŒ‡ä»¤ï¼šå¯„å­˜å™¨å¯¹å¯„å­˜å™¨ï¼Œfunct3+funct7 å®šä¹‰è¿ç®—ï¼Œç»“æœå†™å› rdã€‚**



## Task 7 (B-type Instructions)

è¿™ä¸€éƒ¨åˆ†è¦æ±‚ä½ åœ¨ **æµæ°´çº¿ CPU** ä¸­å®ç° **B-type æŒ‡ä»¤**ï¼Œä¹Ÿå°±æ˜¯ **æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤**ã€‚è¿™äº›æŒ‡ä»¤æ ¹æ®å¯„å­˜å™¨æ¯”è¾ƒç»“æœï¼Œå†³å®šæ˜¯å¦æ›´æ–° PC ä¸ºè·³è½¬ç›®æ ‡åœ°å€ã€‚

### âœ… ä½ éœ€è¦å®ç°çš„å†…å®¹

#### 1. B-type æŒ‡ä»¤æ ¼å¼

- **opcode = 0x63**
- å­—æ®µï¼š
  - `rs1`, `rs2`ï¼šæºå¯„å­˜å™¨
  - `funct3`ï¼šå†³å®šæ¯”è¾ƒç±»å‹
  - `imm[12:1]`ï¼šåˆ†æ”¯åç§»é‡ï¼ˆç”± Immediate Generator ç”Ÿæˆï¼Œæœ€ä½ä½å›ºå®šä¸º 0ï¼‰

#### 2. æ”¯æŒçš„æŒ‡ä»¤

| æŒ‡ä»¤ | funct3 | è¿ç®—è¯´æ˜                               |
| ---- | ------ | -------------------------------------- |
| beq  | 000    | å¦‚æœ `R[rs1] == R[rs2]` â†’ è·³è½¬         |
| bne  | 001    | å¦‚æœ `R[rs1] != R[rs2]` â†’ è·³è½¬         |
| blt  | 100    | å¦‚æœ `R[rs1] < R[rs2]`ï¼ˆæœ‰ç¬¦å·ï¼‰â†’ è·³è½¬ |
| bge  | 101    | å¦‚æœ `R[rs1] â‰¥ R[rs2]`ï¼ˆæœ‰ç¬¦å·ï¼‰â†’ è·³è½¬ |
| bltu | 110    | å¦‚æœ `R[rs1] < R[rs2]`ï¼ˆæ— ç¬¦å·ï¼‰â†’ è·³è½¬ |
| bgeu | 111    | å¦‚æœ `R[rs1] â‰¥ R[rs2]`ï¼ˆæ— ç¬¦å·ï¼‰â†’ è·³è½¬ |

### ğŸ› ï¸ å®ç°æ­¥éª¤

1. **Immediate Generator**
   - æ‹¼æ¥ B-type ç«‹å³æ•°ï¼š `imm[12] = instr[31]`   `imm[11] = instr[7]`   `imm[10:5] = instr[30:25]`   `imm[4:1] = instr[11:8]`   `imm[0] = 0`
   - ç¬¦å·æ‰©å±•åˆ° 32 ä½
2. **ALU æ¯”è¾ƒé€»è¾‘**
   - ALU æˆ–ä¸“é—¨æ¯”è¾ƒå™¨åˆ¤æ–­ `rs1` ä¸ `rs2` çš„å…³ç³»
   - æ ¹æ® `funct3` é€‰æ‹©æ¯”è¾ƒæ–¹å¼ï¼ˆç­‰äºã€ä¸ç­‰ã€æœ‰ç¬¦å·/æ— ç¬¦å·å¤§å°ï¼‰
3. **PC æ›´æ–°é€»è¾‘**
   - å¦‚æœæ¡ä»¶æˆç«‹ï¼š`PC â† PC + imm`
   - å¦åˆ™ï¼š`PC â† PC + 4`
   - æ§åˆ¶ä¿¡å·ï¼š`PCSel = 1` è¡¨ç¤ºåˆ†æ”¯è·³è½¬
4. **æµæ°´çº¿ flush**
   - å¦‚æœåˆ†æ”¯æˆç«‹ï¼ŒIF é˜¶æ®µå·²ç»å–çš„ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯é”™çš„ â†’ å¿…é¡» flushï¼ˆæ›¿æ¢ä¸º `nop`ï¼‰

### ğŸ§ª æµ‹è¯•æ–¹å¼

è¿è¡Œ B-type æŒ‡ä»¤æµ‹è¯•ï¼š

bash

```
bash test.sh test_integration_b_type -p
```

### âœ… æ€»ç»“å£è¯€

> **Bå‹åˆ†æ”¯ï¼šæ¯”è¾ƒ rs1/rs2ï¼Œæ¡ä»¶æˆç«‹è·³è½¬ PC+immï¼Œå¦åˆ™é¡ºåº PC+4ï¼›åˆ†æ”¯è¦ flushã€‚**





## Task 8 (Loading and Storing)

è¿™ä¸€éƒ¨åˆ†è¦æ±‚ä½ åœ¨ **æµæ°´çº¿ CPU** ä¸­å®ç° **Load å’Œ Store æŒ‡ä»¤**ï¼Œä¹Ÿå°±æ˜¯å†…å­˜è®¿é—®æŒ‡ä»¤ã€‚å®ƒä»¬å±äº I-typeï¼ˆLoadï¼‰å’Œ S-typeï¼ˆStoreï¼‰ï¼Œéœ€è¦æ­£ç¡®å¤„ç†åœ°å€è®¡ç®—ã€æ•°æ®è¯»å†™ï¼Œä»¥åŠéƒ¨åˆ†å­—èŠ‚/åŠå­—çš„æ‰©å±•ã€‚

### âœ… ä½ éœ€è¦å®ç°çš„å†…å®¹

#### 1. Load æŒ‡ä»¤ï¼ˆopcode = `0x03`ï¼‰

- **lb**: `R[rd] â† SignExt(Mem[R[rs1] + imm][7:0])`
- **lh**: `R[rd] â† SignExt(Mem[R[rs1] + imm][15:0])`
- **lw**: `R[rd] â† Mem[R[rs1] + imm]`
- **lbu**: `R[rd] â† ZeroExt(Mem[R[rs1] + imm][7:0])`
- **lhu**: `R[rd] â† ZeroExt(Mem[R[rs1] + imm][15:0])`

ğŸ“Œ æ³¨æ„ï¼š

- åœ°å€è®¡ç®—ï¼š`MemAddr = R[rs1] + imm`
- ä½¿ç”¨ **partial_load.circ** æå–æ­£ç¡®å­—èŠ‚å¹¶æ‰©å±•

#### 2. Store æŒ‡ä»¤ï¼ˆopcode = `0x23`ï¼‰

- **sb**: `Mem[R[rs1] + imm] â† R[rs2][7:0]`
- **sh**: `Mem[R[rs1] + imm] â† R[rs2][15:0]`
- **sw**: `Mem[R[rs1] + imm] â† R[rs2]`

ğŸ“Œ æ³¨æ„ï¼š

- åœ°å€è®¡ç®—ï¼š`MemAddr = R[rs1] + imm`
- ä½¿ç”¨ **partial_store.circ** æ’å…¥æ­£ç¡®å­—èŠ‚å¹¶ç”Ÿæˆå†™æ©ç 

#### 3. Datapath è¦ç‚¹

- ALU ç”¨æ¥è®¡ç®—å†…å­˜åœ°å€ï¼š`R[rs1] + imm`
- DMEM æ¥æ”¶åœ°å€å’Œæ•°æ®
- Load æŒ‡ä»¤ç»“æœé€šè¿‡ **WBSel** å†™å›å¯„å­˜å™¨
- Store æŒ‡ä»¤åªå†™å†…å­˜ï¼Œä¸å†™å¯„å­˜å™¨
- æ§åˆ¶ä¿¡å·ï¼š
  - `MemRW = 1` â†’ å†™å†…å­˜
  - `MemRW = 0` â†’ è¯»å†…å­˜
  - `WBSel = Mem` â†’ å†™å›å¯„å­˜å™¨æ¥è‡ªå†…å­˜

#### 4. æµæ°´çº¿ Hazard

- Load æŒ‡ä»¤çš„ç»“æœåœ¨ EX é˜¶æ®µè¿˜æ²¡å‡†å¤‡å¥½ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤å¯èƒ½éœ€è¦ â†’ éœ€è¦ **stall æˆ– forward**
- Store æŒ‡ä»¤åªå½±å“å†…å­˜ï¼Œä¸éœ€è¦å†™å›å¯„å­˜å™¨ï¼Œä½†è¦ä¿è¯åœ°å€å’Œæ•°æ®åœ¨åŒä¸€å‘¨æœŸé€åˆ° DMEM

### ğŸ§ª æµ‹è¯•æ–¹å¼

è¿è¡Œ Load/Store æŒ‡ä»¤æµ‹è¯•ï¼š

bash

```
bash test.sh test_integration_load_store -p
```

### âœ… æ€»ç»“å£è¯€

> **Load è¯»å†…å­˜å†™å›å¯„å­˜å™¨ï¼ŒStore å†™å¯„å­˜å™¨æ•°æ®åˆ°å†…å­˜ï¼›åœ°å€é  ALUï¼Œå­—èŠ‚é  partialã€‚**





# `partial_load.circ` **å’Œ** `partial_store.circ`

ä¸ºä»€ä¹ˆéœ€è¦ partial load/storeï¼Ÿ

åœ¨ RISC-V ä¸­ï¼š

- `lw` / `sw`ï¼šè®¿é—®æ•´ä¸ª 32 ä½ word
- `lh` / `sh`ï¼šè®¿é—® 16 ä½ half-word
- `lb` / `sb`ï¼šè®¿é—® 8 ä½ byte

ä½† Logisim çš„ DMEM æ€»æ˜¯ä¸€æ¬¡è¿”å›/å†™å…¥ **32 ä½å¯¹é½çš„ 4 å­—èŠ‚å—**ï¼Œä½ å¿…é¡»ä»ä¸­**æå–æˆ–æ’å…¥éƒ¨åˆ†å­—èŠ‚**ã€‚

## ğŸ”¹ `partial_load.circ`ï¼šä» DMEM ä¸­æå–æ­£ç¡®çš„å­—èŠ‚

#### è¾“å…¥ï¼š

- `Instruction`ï¼šå½“å‰æŒ‡ä»¤ï¼ˆç”¨äºè¯†åˆ«æ˜¯ `lb`, `lh`, `lw`ï¼‰
- `MemAddress`ï¼šåŸå§‹åœ°å€ï¼ˆæœªå¯¹é½ï¼‰
- `DataFromMem`ï¼šDMEM è¿”å›çš„ 32 ä½æ•°æ®

#### è¾“å‡ºï¼š

- `DataToReg`ï¼šè¦å†™å…¥å¯„å­˜å™¨çš„ 32 ä½æ•°æ®ï¼ˆå¸¦ç¬¦å·æ‰©å±•ï¼‰

ä½ éœ€è¦æ ¹æ®ï¼š

- æŒ‡ä»¤ç±»å‹ï¼ˆé€šè¿‡ `funct3` åˆ¤æ–­ï¼‰
- åœ°å€çš„ä½ä¸¤ä½ï¼ˆå†³å®šä»å“ªä¸€å­—èŠ‚å¼€å§‹æå–ï¼‰

æ¥é€‰æ‹©æ­£ç¡®çš„å­—èŠ‚å¹¶è¿›è¡Œç¬¦å·æ‰©å±•ã€‚

#### ç¤ºä¾‹ï¼š

- `lb` åœ°å€æœ«å°¾æ˜¯ `0b10` â†’ æå– `DataFromMem[23:16]` â†’ `SignExt`
- `lh` åœ°å€æœ«å°¾æ˜¯ `0b01` â†’ æå– `DataFromMem[23:8]` â†’ `SignExt`

### å…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š

| ä¿¡å·åç§°    | æ–¹å‘ | ä½å®½ | æè¿°                             |
| ----------- | ---- | ---- | -------------------------------- |
| Instruction | è¾“å…¥ | 32   | æ­£åœ¨æ‰§è¡Œçš„ load æŒ‡ä»¤             |
| MemAddress  | è¾“å…¥ | 32   | è¦è¯»å–çš„å†…å­˜åœ°å€ï¼ˆä½ä¸¤ä½ä¸æ¸…é›¶ï¼‰ |
| DataFromMem | è¾“å…¥ | 32   | ä» DMEM è¯»å–çš„æ•°æ®               |
| DataToReg   | è¾“å‡º | 32   | è¦å†™å…¥å¯„å­˜å™¨çš„æ•°æ®               |

| æŒ‡ä»¤               | ç±»å‹ | Opcode | Funct3 | MemAddress ä½ä¸¤ä½ | å†™å…¥ DataToReg çš„å€¼         |
| ------------------ | ---- | ------ | ------ | ----------------- | --------------------------- |
| lb rd, offset(rs1) | I    | 0x03   | 0x0    | 0b00              | SignExt(DataFromMem[7:0])   |
|                    |      |        |        | 0b01              | SignExt(DataFromMem[15:8])  |
|                    |      |        |        | 0b10              | SignExt(DataFromMem[23:16]) |
|                    |      |        |        | 0b11              | SignExt(DataFromMem[31:24]) |
| lh rd, offset(rs1) | I    | 0x03   | 0x1    | 0b00              | SignExt(DataFromMem[15:0])  |
|                    |      |        |        | 0b01              | SignExt(DataFromMem[23:8])  |
|                    |      |        |        | 0b10              | SignExt(DataFromMem[31:16]) |
| lw rd, offset(rs1) | I    | 0x03   | 0x2    | 0b00              | DataFromMem                 |

## ğŸ”¹ `partial_store.circ`ï¼šå°†éƒ¨åˆ†æ•°æ®å†™å…¥ DMEM

#### è¾“å…¥ï¼š

- `Instruction`ï¼šå½“å‰æŒ‡ä»¤ï¼ˆç”¨äºè¯†åˆ«æ˜¯ `sb`, `sh`, `sw`ï¼‰
- `MemAddress`ï¼šåŸå§‹åœ°å€ï¼ˆæœªå¯¹é½ï¼‰
- `DataFromReg`ï¼šå¯„å­˜å™¨ä¸­çš„æ•°æ®
- `MemWEn`ï¼šæ˜¯å¦å¯ç”¨å†™å…¥

#### è¾“å‡ºï¼š

- `DataToMem`ï¼šè¦å†™å…¥ DMEM çš„ 32 ä½æ•°æ®ï¼ˆæ­£ç¡®æ’å…¥ç›®æ ‡å­—èŠ‚ï¼‰
- `MemWriteMask`ï¼š4 ä½æ©ç ï¼ŒæŒ‡ç¤ºå“ªäº›å­—èŠ‚è¦å†™å…¥

ä½ éœ€è¦æ ¹æ®ï¼š

- æŒ‡ä»¤ç±»å‹ï¼ˆé€šè¿‡ `funct3` åˆ¤æ–­ï¼‰
- åœ°å€çš„ä½ä¸¤ä½ï¼ˆå†³å®šå†™å…¥ä½ç½®ï¼‰

æ¥æ„é€ æ­£ç¡®çš„ `DataToMem` å’Œ `MemWriteMask`

#### ç¤ºä¾‹ï¼š

- `sb` åœ°å€æœ«å°¾æ˜¯ `0b11` â†’ æŠŠ `DataFromReg[7:0]` æ”¾åˆ° `DataToMem[31:24]`ï¼Œæ©ç ä¸º `0b1000`
- `sh` åœ°å€æœ«å°¾æ˜¯ `0b10` â†’ æ”¾åˆ° `DataToMem[31:16]`ï¼Œæ©ç ä¸º `0b1100`

## å…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š

| ä¿¡å·åç§°     | æ–¹å‘ | ä½å®½ | æè¿°                                    |
| ------------ | ---- | ---- | --------------------------------------- |
| Instruction  | è¾“å…¥ | 32   | æ­£åœ¨æ‰§è¡Œçš„ store æŒ‡ä»¤                   |
| MemAddress   | è¾“å…¥ | 32   | è¦å†™å…¥çš„å†…å­˜åœ°å€ï¼ˆä½ä¸¤ä½ä¸æ¸…é›¶ï¼‰        |
| DataFromReg  | è¾“å…¥ | 32   | æ¥è‡ªå¯„å­˜å™¨çš„æ•°æ®                        |
| MemWEn       | è¾“å…¥ | 1    | æ§åˆ¶ä¿¡å·ï¼ŒæŒ‡ç¤ºæ˜¯å¦å…è®¸å†™å…¥å†…å­˜          |
| DataToMem    | è¾“å‡º | 32   | è¦å†™å…¥å†…å­˜çš„æ•°æ®                        |
| MemWriteMask | è¾“å‡º | 4    | å†™æ©ç ï¼ŒæŒ‡ç¤º DataToMem çš„å“ªäº›å­—èŠ‚ä¼šå†™å…¥ |

| æŒ‡ä»¤                | Funct3 | MemAddress ä½ä¸¤ä½ | DataToMem (å„å­—èŠ‚ä½ç½®)                                 | MemWriteMask |
| ------------------- | ------ | ----------------- | ------------------------------------------------------ | ------------ |
| sb rs2, offset(rs1) | 0x0    | 0b00              | [31-24]=0, [23-16]=0, [15-8]=0, [7-0]=DataFromReg[7:0] | 0b0001       |
|                     |        | 0b01              | [31-24]=0, [23-16]=0, [15-8]=DataFromReg[7:0], [7-0]=0 | 0b0010       |
|                     |        | 0b10              | [31-24]=0, [23-16]=DataFromReg[7:0], [15-8]=0, [7-0]=0 | 0b0100       |
|                     |        | 0b11              | [31-24]=DataFromReg[7:0], [23-16]=0, [15-8]=0, [7-0]=0 | 0b1000       |
| sh rs2, offset(rs1) | 0x1    | 0b00              | [31-16]=0, [15-0]=DataFromReg[15:0]                    | 0b0011       |
|                     |        | 0b10              | [31-16]=DataFromReg[15:0], [15-0]=0                    | 0b1100       |
| sw rs2, offset(rs1) | 0x2    | 0b00              | [31-0]=DataFromReg                                     | 0b1111       |



### æµ‹è¯•æ–¹å¼

ä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•ä½ çš„å­ç”µè·¯ï¼š

bash

```
bash test.sh test_partial_load
bash test.sh test_partial_store
```

> **DMEM æ€»æ˜¯è¿”å› 32 ä½ï¼Œä½ è¦æå–æˆ–æ’å…¥æ­£ç¡®çš„å­—èŠ‚ï¼›åœ°å€ä½ä¸¤ä½å†³å®šä½ç½®ï¼Œfunct3 å†³å®šé•¿åº¦ã€‚**





## æ§åˆ¶é€»è¾‘

| ä¿¡å·åç§° | ä½å®½ | ç›®çš„                                                         |
| -------- | ---- | ------------------------------------------------------------ |
| PCSel    | 1    | å¯¹æ‰€æœ‰ B å‹åˆ†æ”¯æŒ‡ä»¤ï¼ˆæ ¹æ®åˆ†æ”¯æ¯”è¾ƒå™¨è¾“å‡ºï¼‰å’Œæ‰€æœ‰è·³è½¬ï¼Œé€‰æ‹© ALU è¾“å…¥ï¼›å…¶ä»–æŒ‡ä»¤é€‰æ‹© PC+4 è¾“å…¥ |
| ImmSel   | 3    | é€‰æ‹©æŒ‡ä»¤æ ¼å¼ï¼Œä½¿ç«‹å³æ•°ç”Ÿæˆå™¨æ­£ç¡®æå–ç«‹å³æ•°ã€‚[0b000=I][0b001=S][0b010=B][0b011=U][0b100=J] |
| RegWEn   | 1    | è‹¥æŒ‡ä»¤å†™å…¥å¯„å­˜å™¨åˆ™ä¸º 1ï¼Œå¦åˆ™ä¸º 0                             |
| BrUn     | 1    | è‹¥åˆ†æ”¯æŒ‡ä»¤ä¸ºæ— ç¬¦å·æ¯”è¾ƒåˆ™ä¸º 1ï¼Œæœ‰ç¬¦å·æ¯”è¾ƒåˆ™ä¸º 0ï¼›å…¶ä»–æŒ‡ä»¤æ— éœ€å…³å¿ƒ |
| ASel     | 1    | é€‰æ‹© ALU çš„ç¬¬ä¸€ä¸ªè¾“å…¥ï¼šæ¥è‡ªå¯„å­˜å™¨ (RegReadData1) æˆ– PC       |
| BSel     | 1    | é€‰æ‹© ALU çš„ç¬¬äºŒä¸ªè¾“å…¥ï¼šæ¥è‡ªå¯„å­˜å™¨ (RegReadData2) æˆ–ç«‹å³æ•°    |
| ALUSel   | 4    | é€‰æ‹© ALU çš„å…·ä½“è¿ç®—åŠŸèƒ½ï¼ˆè§ä»»åŠ¡ 1 çš„ ALU åŠŸèƒ½æ˜ å°„è¡¨ï¼‰        |
| MemRW    | 1    | è‹¥æŒ‡ä»¤å†™å…¥å†…å­˜åˆ™ä¸º 1ï¼Œå¦åˆ™ä¸º 0                               |
| WBSel    | 2    | é€‰æ‹©å†™å›å¯„å­˜å™¨çš„æ•°æ®æ¥æºï¼šæ¥è‡ª DMEMã€ALU è¾“å‡ºæˆ– PC+4         |